<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Simples - Vendas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .stat-card {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            min-width: 150px;
        }
        .stat-card h3 {
            margin: 0;
            font-size: 24px;
        }
        .stat-card p {
            margin: 5px 0 0 0;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: red;
            text-align: center;
            padding: 20px;
        }
        .success {
            color: green;
            text-align: center;
            padding: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard de Vendas - Versão Simples</h1>
        
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="loadData()">Carregar Dados</button>
            <button onclick="updateData()">Atualizar Dados</button>
        </div>
        
        <div id="status" class="loading">Carregando dados...</div>
        
        <div class="stats" id="stats">
            <!-- Estatísticas serão inseridas aqui -->
        </div>
        
        <div id="data-info">
            <!-- Informações dos dados serão inseridas aqui -->
        </div>
        
        <table class="data-table" id="data-table">
            <thead id="table-headers">
                <!-- Cabeçalhos serão inseridos aqui -->
            </thead>
            <tbody id="table-body">
                <!-- Dados serão inseridos aqui -->
            </tbody>
        </table>
    </div>

    <script>
        // Carrega dados automaticamente ao abrir a página
        window.onload = function() {
            loadData();
        };

        async function loadData() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="loading">Carregando dados...</div>';
            
            try {
                const response = await fetch('/api/data');
                const result = await response.json();
                
                console.log('Resposta da API:', result);
                
                if (result.data) {
                    let allData = [];
                    let totalRecords = 0;
                    let totalSheets = 0;
                    
                    if (Array.isArray(result.data)) {
                        // Dados de uma única guia
                        allData = result.data;
                        totalRecords = result.count || result.data.length;
                        totalSheets = 1;
                    } else {
                        // Dados de múltiplas guias
                        for (const [sheetKey, sheetData] of Object.entries(result.data)) {
                            if (sheetData.dados && Array.isArray(sheetData.dados)) {
                                allData = allData.concat(sheetData.dados);
                                totalRecords += sheetData.total_registros || 0;
                                totalSheets++;
                            }
                        }
                    }
                    
                    if (allData.length > 0) {
                        displayData(allData);
                        updateStats(allData, totalRecords, totalSheets);
                        document.getElementById('data-info').innerHTML = `
                            <h3>Informações dos Dados</h3>
                            <p><strong>Última atualização:</strong> ${result.last_update || 'N/A'}</p>
                            <p><strong>Total de registros:</strong> ${totalRecords}</p>
                            <p><strong>Guias processadas:</strong> ${totalSheets}</p>
                        `;
                        statusDiv.innerHTML = '<div class="success">Dados carregados com sucesso!</div>';
                    } else {
                        statusDiv.innerHTML = '<div class="error">Nenhum dado encontrado</div>';
                    }
                } else {
                    statusDiv.innerHTML = '<div class="error">Resposta inválida da API</div>';
                }
            } catch (error) {
                console.error('Erro:', error);
                statusDiv.innerHTML = `<div class="error">Erro ao carregar dados: ${error.message}</div>`;
            }
        }

        async function updateData() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="loading">Atualizando dados...</div>';
            
            try {
                const response = await fetch('/api/update', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '<div class="success">Dados atualizados com sucesso!</div>';
                    // Recarrega os dados após atualização
                    setTimeout(loadData, 1000);
                } else {
                    statusDiv.innerHTML = `<div class="error">Erro na atualização: ${result.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Erro ao atualizar: ${error.message}</div>`;
            }
        }

        function displayData(data) {
            const table = document.getElementById('data-table');
            const headers = document.getElementById('table-headers');
            const body = document.getElementById('table-body');
            
            // Limpa tabela
            headers.innerHTML = '';
            body.innerHTML = '';
            
            if (!data || data.length === 0) {
                body.innerHTML = '<tr><td colspan="100%">Nenhum dado para exibir</td></tr>';
                return;
            }
            
            // Cria cabeçalhos
            const columns = Object.keys(data[0]);
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headers.appendChild(th);
            });
            
            // Adiciona dados (máximo 50 linhas para simplicidade)
            const displayData = data.slice(0, 50);
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = row[column] || '';
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
            
            if (data.length > 50) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = columns.length;
                td.textContent = `... e mais ${data.length - 50} registros`;
                td.style.textAlign = 'center';
                td.style.fontStyle = 'italic';
                tr.appendChild(td);
                body.appendChild(tr);
            }
        }

        function updateStats(data, totalRecords, totalSheets) {
            const statsGrid = document.getElementById('stats');
            
            if (!data || data.length === 0) {
                statsGrid.innerHTML = '<div class="stat-card"><h3>0</h3><p>Registros</p></div>';
                return;
            }
            
            const columns = Object.keys(data[0]);
            
            let statsHTML = `
                <div class="stat-card">
                    <h3>${totalRecords}</h3>
                    <p>Total de Registros</p>
                </div>
                <div class="stat-card">
                    <h3>${totalSheets}</h3>
                    <p>Guias Processadas</p>
                </div>
                <div class="stat-card">
                    <h3>${columns.length}</h3>
                    <p>Colunas</p>
                </div>
            `;
            
            // Calcula receita total se existir a coluna
            if (data[0]['Receita Total']) {
                const totalRevenue = data.reduce((sum, row) => {
                    const revenue = parseFloat(row['Receita Total']) || 0;
                    return sum + revenue;
                }, 0);
                
                statsHTML += `
                    <div class="stat-card">
                        <h3>R$ ${totalRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h3>
                        <p>Receita Total</p>
                    </div>
                `;
            }
            
            statsGrid.innerHTML = statsHTML;
        }
    </script>
</body>
</html>
